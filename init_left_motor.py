#!/usr/bin/env python3
"""
COMPLETE INITIALIZATION - With proper SDO response waiting
"""

import can
import struct
import time

bus = can.Bus(channel='can0', interface='socketcan')

def wait_for_sdo_response(timeout=0.5):
    """Wait for SDO response (0x581)"""
    start = time.time()
    while time.time() - start < timeout:
        msg = bus.recv(timeout=0.1)
        if msg and msg.arbitration_id == 0x581:
            return True
    print("  WARNING: No SDO response!")
    return False

def send_sdo(data):
    """Send SDO and wait for response"""
    bus.send(can.Message(arbitration_id=0x601, data=data, is_extended_id=False))
    return wait_for_sdo_response()

def send_cmd(ctrl, vel=0):
    """Send RPDO command + SYNC"""
    msg = can.Message(arbitration_id=0x501, data=struct.pack('<HiH', ctrl, vel, 0), is_extended_id=False)
    bus.send(msg)
    time.sleep(0.002)
    sync = can.Message(arbitration_id=0x080, data=[], is_extended_id=False)
    bus.send(sync)
    time.sleep(0.008)

def send_nmt(data):
    """Send NMT command"""
    bus.send(can.Message(arbitration_id=0x000, data=data, is_extended_id=False))
    time.sleep(0.1)

print("="*70)
print("COMPLETE INITIALIZATION - With SDO response verification")
print("="*70)

# Reset nodes
print("\n[1/9] Resetting nodes 1,2,3,4...")
for n in [1,2,3,4]:
    send_nmt(bytes([0x80, n]))
time.sleep(0.5)

# CRITICAL: ALL SDO configurations with response waiting
print("[2/9] Configuring manufacturer parameters (this will take ~30 seconds)...")
print("  (Waiting for each SDO response...)")

sdo_count = 0
send_sdo(bytes([0x42, 0x02, 0x20, 0x05, 0x00, 0x00, 0x00, 0x00]))
sdo_count += 1

# Lines 8-55: PDO configuration
print(f"  [{sdo_count}] PDO mappings...")
send_sdo(bytes([0x42, 0x00, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x00, 0x14, 0x01, 0x01, 0x02, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x01, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x01, 0x14, 0x01, 0x01, 0x03, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x02, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x02, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x03, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x03, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x04, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x04, 0x14, 0x01, 0x21, 0x04, 0x00, 0x80]))
sdo_count += 10

print(f"  [{sdo_count}] More PDO mappings...")
send_sdo(bytes([0x42, 0x14, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x14, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x15, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x15, 0x14, 0x01, 0x11, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x16, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x16, 0x14, 0x01, 0x21, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x17, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x17, 0x14, 0x01, 0x31, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x19, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x14, 0x01, 0x00, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x20, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x20, 0x14, 0x01, 0x51, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x21, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x21, 0x14, 0x01, 0x61, 0x05, 0x00, 0x80]))
sdo_count += 14

print(f"  [{sdo_count}] Motor parameters...")
send_sdo(bytes([0x42, 0xCA, 0x20, 0x07, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xCA, 0x20, 0x08, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xCA, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xCA, 0x20, 0x0A, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xD8, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x0F, 0x20, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xD8, 0x20, 0x0C, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xD8, 0x20, 0x24, 0x00, 0x00, 0x00, 0x00]))
sdo_count += 8

print(f"  [{sdo_count}] Advanced config...")
send_sdo(bytes([0x21, 0x3C, 0x20, 0x09, 0x08, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x00, 0xFF, 0x40, 0x55, 0x55, 0x0D, 0x00, 0x00]))
send_sdo(bytes([0x11, 0x00, 0x40, 0x55, 0x55, 0x0D, 0x00, 0x00]))
send_sdo(bytes([0x40, 0x3C, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x60, 0x3C, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x70, 0x3C, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
sdo_count += 6

print(f"  [{sdo_count}] Profile parameters (CRITICAL)...")
send_sdo(bytes([0x23, 0x37, 0x20, 0x01, 0x00, 0x00, 0x1E, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x02, 0x11, 0x11, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x03, 0x11, 0x11, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x04, 0x55, 0x55, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x05, 0xAA, 0xAA, 0x1A, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x06, 0x56, 0x55, 0xE5, 0xFF]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x07, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x02, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x03, 0x00, 0x00, 0x00, 0x40]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x04, 0x00, 0x00, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x05, 0x64, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x06, 0x64, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x07, 0xA0, 0x0F, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x08, 0x00, 0x00, 0x00, 0x40]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x09, 0x00, 0x00, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x0A, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x0B, 0x00, 0x00, 0x00, 0x00]))
sdo_count += 18

print("[3/9] Configuring RPDO/TPDO mappings...")
send_sdo(bytes([0x42, 0x03, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x03, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x03, 0x14, 0x01, 0x01, 0x05, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x03, 0x14, 0x02, 0x01, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x42, 0x03, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x03, 0x18, 0x01, 0x81, 0x01, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x03, 0x18, 0x01, 0x81, 0x01, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x03, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x42, 0x14, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x14, 0x18, 0x01, 0x81, 0x02, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x14, 0x18, 0x01, 0x81, 0x02, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x14, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x42, 0x16, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x16, 0x18, 0x01, 0x81, 0x03, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x16, 0x18, 0x01, 0x81, 0x03, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x16, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x42, 0x19, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x18, 0x01, 0x81, 0x04, 0x00, 0x80]))

send_sdo(bytes([0x2F, 0x19, 0x1A, 0x00, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x01, 0x10, 0x01, 0x0F, 0x20]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x02, 0x10, 0x02, 0x02, 0x20]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x03, 0x10, 0x03, 0x02, 0x20]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x04, 0x10, 0x05, 0x02, 0x20]))
send_sdo(bytes([0x2F, 0x19, 0x1A, 0x00, 0x04, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x23, 0x19, 0x18, 0x01, 0x81, 0x04, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x19, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))

print("[4/9] Reset & control word sequence...")
send_nmt(bytes([0x80, 0x01]))
time.sleep(0.2)

send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x80, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2F, 0x60, 0x60, 0x00, 0x03, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x23, 0xFF, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x23, 0x83, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00]))
time.sleep(0.1)

send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x80, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x06, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x07, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x0F, 0x00, 0x00, 0x00]))
time.sleep(0.1)

print("[5/9] Starting node...")
send_nmt(bytes([0x01, 0x01]))
time.sleep(0.5)

print("[6/9] Final configuration...")
send_sdo(bytes([0x2B, 0x86, 0x60, 0x00, 0x02, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x01, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x02, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x03, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x04, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x0C, 0x10, 0x00, 0x0A, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x0D, 0x10, 0x00, 0xFA, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x2B, 0x5A, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x5A, 0x20, 0x2E, 0x01, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x5A, 0x20, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x65, 0x20, 0x2B, 0x0A, 0x00, 0x00, 0x00]))

send_sdo(bytes([0x42, 0x41, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00]))
time.sleep(0.2)

print("[7/9] State machine via RPDO...")
send_cmd(0x0080, 0)
for _ in range(5):
    send_cmd(0x0006, 0)
for _ in range(5):
    send_cmd(0x0007, 0)
for _ in range(10):
    send_cmd(0x000F, 0)

print("\n[8/9] Configuration complete! Check motor status...")
print("      Run the monitor script to see if status changed to 0x0237")
time.sleep(1)

print("[9/9] Attempting to run motors...")
print("      Press Ctrl+C to stop\n")

try:
    # i = 0
    # velocity = 235929
    
    # while True:
    #     send_cmd(0x000F, velocity)
        
    #     if i % 100 == 0:
    #         print(f"[{i*10:5d}ms] Sending velocity {velocity}...")
    #     i += 1
    print("Run Motors now")

except KeyboardInterrupt:
    print("\n\nStopping...")
    for _ in range(30):
        send_cmd(0x000F, 0)

finally:
    for _ in range(10):
        send_cmd(0x0006, 0)
    bus.shutdown()
    print("Done! Run monitor script")