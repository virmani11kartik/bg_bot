#!/usr/bin/env python3
"""
RIGHT MOTOR (NODE 2) - Complete Initialization
"""
import can
import struct
import time

bus = can.Bus(channel='can0', interface='socketcan')
NODE = 2

def wait_for_sdo_response(timeout=0.5):
    """Wait for SDO response (0x582)"""
    start = time.time()
    while time.time() - start < timeout:
        msg = bus.recv(timeout=0.1)
        if msg and msg.arbitration_id == 0x582:  # Node 2
            return True
    print("  WARNING: No SDO response!")
    return False

def send_sdo(data):
    """Send SDO and wait for response"""
    bus.send(can.Message(arbitration_id=0x602, data=data, is_extended_id=False))  # Node 2
    return wait_for_sdo_response()

def send_cmd(ctrl, vel=0):
    """Send RPDO command + SYNC to Node 2"""
    msg = can.Message(arbitration_id=0x502, data=struct.pack('<HiH', ctrl, vel, 0), is_extended_id=False)  # Node 2
    bus.send(msg)
    time.sleep(0.002)
    sync = can.Message(arbitration_id=0x080, data=[], is_extended_id=False)
    bus.send(sync)
    time.sleep(0.008)

def send_nmt(data):
    """Send NMT command"""
    bus.send(can.Message(arbitration_id=0x000, data=data, is_extended_id=False))
    time.sleep(0.1)

print("="*70)
print("RIGHT MOTOR (NODE 2) - COMPLETE INITIALIZATION")
print("="*70)

# Reset Node 2
print("\n[1/9] Resetting Node 2...")
send_nmt(bytes([0x80, NODE]))
time.sleep(0.5)

# CRITICAL: ALL SDO configurations
print("[2/9] Configuring manufacturer parameters...")
send_sdo(bytes([0x42, 0x02, 0x20, 0x05, 0x00, 0x00, 0x00, 0x00]))

print("[3/9] PDO mappings...")
send_sdo(bytes([0x42, 0x00, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x00, 0x14, 0x01, 0x01, 0x02, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x01, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x01, 0x14, 0x01, 0x01, 0x03, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x02, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x02, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x03, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x03, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x04, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x04, 0x14, 0x01, 0x21, 0x04, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x14, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x14, 0x14, 0x01, 0x01, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x15, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x15, 0x14, 0x01, 0x11, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x16, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x16, 0x14, 0x01, 0x21, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x17, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x17, 0x14, 0x01, 0x31, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x19, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x14, 0x01, 0x00, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x20, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x20, 0x14, 0x01, 0x51, 0x05, 0x00, 0x80]))
send_sdo(bytes([0x42, 0x21, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x21, 0x14, 0x01, 0x61, 0x05, 0x00, 0x80]))

print("[4/9] Motor parameters...")
send_sdo(bytes([0x42, 0xCA, 0x20, 0x07, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xCA, 0x20, 0x08, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xCA, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xCA, 0x20, 0x0A, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xD8, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x0F, 0x20, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xD8, 0x20, 0x0C, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0xD8, 0x20, 0x24, 0x00, 0x00, 0x00, 0x00]))

print("[5/9] Advanced config...")
send_sdo(bytes([0x21, 0x3C, 0x20, 0x09, 0x08, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x00, 0xFF, 0x40, 0x55, 0x55, 0x0D, 0x00, 0x00]))
send_sdo(bytes([0x11, 0x00, 0x40, 0x55, 0x55, 0x0D, 0x00, 0x00]))
send_sdo(bytes([0x40, 0x3C, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x60, 0x3C, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x70, 0x3C, 0x20, 0x09, 0x00, 0x00, 0x00, 0x00]))

print("[6/9] Profile parameters...")
send_sdo(bytes([0x23, 0x37, 0x20, 0x01, 0x00, 0x00, 0x1E, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x02, 0x11, 0x11, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x03, 0x11, 0x11, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x04, 0x55, 0x55, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x05, 0xAA, 0xAA, 0x1A, 0x00]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x06, 0x56, 0x55, 0xE5, 0xFF]))
send_sdo(bytes([0x23, 0x37, 0x20, 0x07, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x02, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x03, 0x00, 0x00, 0x00, 0x40]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x04, 0x00, 0x00, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x05, 0x64, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x06, 0x64, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x07, 0xA0, 0x0F, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x08, 0x00, 0x00, 0x00, 0x40]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x09, 0x00, 0x00, 0x00, 0x80]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x0A, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x39, 0x20, 0x0B, 0x00, 0x00, 0x00, 0x00]))

print("[7/9] RPDO/TPDO mappings...")
send_sdo(bytes([0x42, 0x03, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x03, 0x14, 0x01, 0x02, 0x05, 0x00, 0x80]))  # Changed for Node 2
send_sdo(bytes([0x23, 0x03, 0x14, 0x01, 0x02, 0x05, 0x00, 0x00]))  # Changed for Node 2
send_sdo(bytes([0x2F, 0x03, 0x14, 0x02, 0x01, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x03, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x03, 0x18, 0x01, 0x82, 0x01, 0x00, 0x80]))  # Changed for Node 2
send_sdo(bytes([0x23, 0x03, 0x18, 0x01, 0x82, 0x01, 0x00, 0x00]))  # Changed for Node 2
send_sdo(bytes([0x2F, 0x03, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x14, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x14, 0x18, 0x01, 0x82, 0x02, 0x00, 0x80]))  # Changed for Node 2
send_sdo(bytes([0x23, 0x14, 0x18, 0x01, 0x82, 0x02, 0x00, 0x00]))  # Changed for Node 2
send_sdo(bytes([0x2F, 0x14, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x16, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x16, 0x18, 0x01, 0x82, 0x03, 0x00, 0x80]))  # Changed for Node 2
send_sdo(bytes([0x23, 0x16, 0x18, 0x01, 0x82, 0x03, 0x00, 0x00]))  # Changed for Node 2
send_sdo(bytes([0x2F, 0x16, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x19, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x18, 0x01, 0x82, 0x04, 0x00, 0x80]))  # Changed for Node 2
send_sdo(bytes([0x2F, 0x19, 0x1A, 0x00, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x01, 0x10, 0x01, 0x0F, 0x20]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x02, 0x10, 0x02, 0x02, 0x20]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x03, 0x10, 0x03, 0x02, 0x20]))
send_sdo(bytes([0x23, 0x19, 0x1A, 0x04, 0x10, 0x05, 0x02, 0x20]))
send_sdo(bytes([0x2F, 0x19, 0x1A, 0x00, 0x04, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x23, 0x19, 0x18, 0x01, 0x82, 0x04, 0x00, 0x00]))  # Changed for Node 2
send_sdo(bytes([0x2F, 0x19, 0x18, 0x02, 0x01, 0x00, 0x00, 0x00]))

print("[8/9] Reset & control word sequence...")
send_nmt(bytes([0x80, NODE]))
time.sleep(0.2)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x80, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2F, 0x60, 0x60, 0x00, 0x03, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x23, 0xFF, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x80, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x06, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x07, 0x00, 0x00, 0x00]))
time.sleep(0.1)
send_sdo(bytes([0x2B, 0x40, 0x60, 0x00, 0x0F, 0x00, 0x00, 0x00]))
time.sleep(0.1)

print("[9/9] Starting node...")
send_nmt(bytes([0x01, NODE]))
time.sleep(0.5)

print("[10/11] Final configuration...")
send_sdo(bytes([0x2B, 0x86, 0x60, 0x00, 0x02, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x01, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x02, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x03, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x21, 0x3C, 0x20, 0x04, 0x06, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x01, 0x3E, 0xC3, 0xAE, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x0C, 0x10, 0x00, 0x0A, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2F, 0x0D, 0x10, 0x00, 0xFA, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x5A, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x5A, 0x20, 0x2E, 0x01, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x5A, 0x20, 0x01, 0x00, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x2B, 0x65, 0x20, 0x2B, 0x0A, 0x00, 0x00, 0x00]))
send_sdo(bytes([0x42, 0x41, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00]))
time.sleep(0.2)

# *** THIS IS THE CRITICAL PART ***
print("[11/11] State machine via RPDO (MOTOR ENGAGE)...")
send_cmd(0x0080, 0)  # Fault reset
for _ in range(5):
    send_cmd(0x0006, 0)  # Shutdown
for _ in range(5):
    send_cmd(0x0007, 0)  # Switch on
for _ in range(10):
    send_cmd(0x000F, 0)  # Enable operation

print("\nâœ“ RIGHT MOTOR INITIALIZED AND ENGAGED!")
print("  Run the RPDO speed test script now")

bus.shutdown()